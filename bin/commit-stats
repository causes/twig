#!/usr/bin/env ruby

require 'bundler'
Bundler.require

$: << File.expand_path('../lib', File.dirname(__FILE__))
require 'twig'

if ARGV.delete('-v') || ARGV.delete('--verbose')
  verbose = true
end

if ARGV.count != 2 || ARGV.include?('-h') || ARGV.include?('--help')
  puts "USAGE: #{__FILE__} [--verbose|-v] <repos dir> <number of days>"
  exit(-1)
end

dir, days_ago = ARGV[0], ARGV[1].to_i

master_set = Twig::Gatherer.gather(dir, days_ago)
master_set.top_authors.each do |top_author_data|
  author     = top_author_data[:author]
  commit_set = top_author_data[:commit_set]
  breakdown = commit_set.count_by_repo.
    map { |data| "#{data[:repo_name]}:#{data[:count]}" }.join(', ')
  puts '%4d %-24s %s' % [commit_set.count, author, breakdown]

  if verbose
    puts
    commit_set.commits.each do |commit|
      puts '    %5s, %5s %s [%s]' % [
        "+#{commit.stat[:additions]}",
        "-#{commit.stat[:deletions]}",
        commit.subject,
        commit.repo.name,
      ]
    end
    puts
  end
end

puts '----'
puts '%4d' % master_set.count
